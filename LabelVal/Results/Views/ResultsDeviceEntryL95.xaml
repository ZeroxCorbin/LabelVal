<!--
    This UserControl displays image and sector data for an L95 device.
    It is divided into two main sections: "Stored" and "Current".
    - The "Stored" section shows data that has been saved to the database.
    - The "Current" section shows data that has been recently read from the device or is being processed.
    The control handles displaying images, lists of sectors, and detailed views for individual sectors.
-->
<UserControl
    x:Class="LabelVal.Results.Views.ResultsDeviceEntry_L95"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:V275Converters="clr-namespace:LabelVal.V275.Converters"
    xmlns:componentmodel="clr-namespace:System.ComponentModel;assembly=WindowsBase"
    xmlns:converters="clr-namespace:LabelVal.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:helpers="clr-namespace:LabelVal.Results.Helpers"
    xmlns:iconPacks="http://metro.mahapps.com/winfx/xaml/iconpacks"
    xmlns:local="clr-namespace:LabelVal.Results.Views"
    xmlns:mah="http://metro.mahapps.com/winfx/xaml/controls"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:md="http://materialdesigninxaml.net/winfx/xaml/themes"
    xmlns:sectors="clr-namespace:LabelVal.Sectors.Views"
    xmlns:vm="clr-namespace:LabelVal.Results.ViewModels"
    d:DataContext="{d:DesignInstance Type=vm:ResultsDeviceEntry_L95,
                                     IsDesignTimeCreatable=False}"
    mc:Ignorable="d">

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <!--  Merges a template for displaying image details.  -->
                <ResourceDictionary Source="ImageDetailsTemplate.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <!--  CollectionViewSource for sorting the stored sectors by their center point coordinates.  -->
            <CollectionViewSource x:Key="StoredSectorsViewSource" Source="{Binding StoredSectors}">
                <CollectionViewSource.SortDescriptions>
                    <componentmodel:SortDescription PropertyName="CenterPoint.X" />
                    <componentmodel:SortDescription PropertyName="CenterPoint.Y" />
                </CollectionViewSource.SortDescriptions>
            </CollectionViewSource>

            <!--  CollectionViewSource for sorting the current sectors by their center point coordinates.  -->
            <CollectionViewSource x:Key="CurrentSectorsViewSource" Source="{Binding CurrentSectors}">
                <CollectionViewSource.SortDescriptions>
                    <componentmodel:SortDescription PropertyName="CenterPoint.X" />
                    <componentmodel:SortDescription PropertyName="CenterPoint.Y" />
                </CollectionViewSource.SortDescriptions>
            </CollectionViewSource>

            <!--  Reusable toolbar for "Stored" items (Image and Sectors). Its content is adapted based on the Tag property.  -->
            <DockPanel x:Key="L95Stored_Toolbar" x:Shared="False">
                <Border Margin="3,0" Style="{StaticResource imageBar}" />

                <!--  Buttons visible only when the context is "Image".  -->
                <DockPanel>
                    <DockPanel.Style>
                        <Style TargetType="{x:Type DockPanel}">
                            <Setter Property="Visibility" Value="Visible" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Path=Tag, RelativeSource={RelativeSource AncestorType=ContentControl}}" Value="Sectors">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DockPanel.Style>

                    <!--  Save Image: Saves the stored image to a file.  -->
                    <Button
                        Width="28"
                        Command="{Binding ResultsEntry.SaveCommand}"
                        CommandParameter="{Binding StoredImage.BitmapBytes}"
                        Content="{iconPacks:Material Kind=ContentSave}"
                        Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}"
                        Style="{StaticResource MahApps.Styles.Button.Hamburger}"
                        ToolTip="Save the stored image to a file." />

                </DockPanel>

                <!--  Button for both "Image" and "Sectors" contexts. The action and tooltip change based on the context.  -->
                <Button
                    Width="28"
                    Click="btnCopyToClipboard_Click"
                    Content="{iconPacks:Modern Kind=PageCopy}"
                    Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}">
                    <Button.Style>
                        <Style BasedOn="{StaticResource MahApps.Styles.Button.Hamburger}" TargetType="{x:Type Button}">
                            <Setter Property="Tag" Value="{Binding StoredSectors}" />
                            <Setter Property="ToolTip" Value="Copy the sectors to the clipboard as CSV." />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Path=Tag, RelativeSource={RelativeSource AncestorType=ContentControl}}" Value="Image">
                                    <Setter Property="Tag" Value="{Binding StoredImage}" />
                                    <Setter Property="ToolTip" Value="Copy the image to the clipboard as a bitmap." />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <!--  Buttons visible only when the context is "Sectors".  -->
                <Button
                    Width="28"
                    Click="StoredSectors_Click"
                    Content="{iconPacks:Modern Kind=SectionExpandAll}"
                    Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}"
                    ToolTip="Show all stored sectors in a popup.">
                    <Button.Style>
                        <Style BasedOn="{StaticResource MahApps.Styles.Button.Hamburger}" TargetType="{x:Type Button}">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Path=Tag, RelativeSource={RelativeSource AncestorType=ContentControl}}" Value="Image">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <!--  Buttons visible only when the context is "Sectors".  -->
                <Button
                    Width="28"
                    Click="StoredSectors_Click"
                    Content="{iconPacks:Material Kind=CodeJson}"
                    Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}"
                    Tag="json"
                    ToolTip="Show the template and report JSON.">
                    <Button.Style>
                        <Style BasedOn="{StaticResource MahApps.Styles.Button.Hamburger}" TargetType="{x:Type Button}">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Path=Tag, RelativeSource={RelativeSource AncestorType=ContentControl}}" Value="Image">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <!--  Buttons visible only when the context is "Image" and the database is not locked.  -->
                <DockPanel>
                    <DockPanel.Style>
                        <Style TargetType="{x:Type DockPanel}">
                            <Setter Property="Visibility" Value="Visible" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Path=Tag, RelativeSource={RelativeSource AncestorType=ContentControl}}" Value="Sectors">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                                <DataTrigger Binding="{Binding ResultssManager.SelectedResultsDatabase.IsLocked}" Value="True">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DockPanel.Style>

                    <Border Margin="3,0" Style="{StaticResource imageBar}" />

                    <!--  Delete Stored Image: Permanently removes the stored image and sectors.  -->
                    <Button
                        Width="28"
                        Command="{Binding ClearStoredCommand}"
                        CommandParameter="{x:Static vm:ResultsEntryDevices.L95}"
                        Content="{iconPacks:Modern Kind=Delete}"
                        Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}"
                        Style="{StaticResource MahApps.Styles.Button.Hamburger}"
                        ToolTip="Permanently remove the stored image and sectors from the database.&#x0a;(CAUTION) This can not be undone!" />

                </DockPanel>

            </DockPanel>

            <!--  Reusable toolbar for "Current" items (Image and Sectors).  -->
            <DockPanel x:Key="CurrentToolbar" x:Shared="False">

                <Border Margin="3,0" Style="{StaticResource imageBar}" />

                <!--  Buttons visible only when the context is "Image".  -->
                <DockPanel>
                    <DockPanel.Style>
                        <Style TargetType="{x:Type DockPanel}">
                            <Setter Property="Visibility" Value="Visible" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Path=Tag, RelativeSource={RelativeSource AncestorType=ContentControl}}" Value="Sectors">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DockPanel.Style>

                    <!--  Save Image: Saves the current image to a file.  -->
                    <Button
                        Width="28"
                        Command="{Binding ResultsEntry.SaveCommand}"
                        CommandParameter="{Binding CurrentImage.BitmapBytes}"
                        Content="{iconPacks:Material Kind=ContentSave}"
                        Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}"
                        Style="{StaticResource MahApps.Styles.Button.Hamburger}"
                        ToolTip="Save the current image to a file." />

                </DockPanel>

                <!--  Store Sectors: Stores the current sectors and image to the database. Visible only for "Sectors" context and when the database is not locked.  -->
                <Button
                    Width="28"
                    Command="{Binding StoreCommand}"
                    Content="{iconPacks:Material Kind=StorePlusOutline}"
                    Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}"
                    ToolTip="Store the current sectors and image to the database.">

                    <Button.Style>
                        <Style BasedOn="{StaticResource MahApps.Styles.Button.Hamburger}" TargetType="{x:Type Button}">
                            <Setter Property="Visibility" Value="Visible" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding ResultssManager.SelectedResultsDatabase.IsLocked}" Value="True">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Path=Tag, RelativeSource={RelativeSource AncestorType=ContentControl}}" Value="Image">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <!--  Store Single Sector: Stores only the selected sector. Visible only for "Sectors" context when a sector is selected and the database is not locked.  -->
                <Button
                    Width="28"
                    Command="{Binding StoreSingleCommand}"
                    Content="{iconPacks:Material Kind=ChevronDoubleLeft}"
                    Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}"
                    ToolTip="Store the selected sector to the database.">

                    <Button.Style>
                        <Style BasedOn="{StaticResource MahApps.Styles.Button.Hamburger}" TargetType="{x:Type Button}">
                            <Setter Property="Visibility" Value="Visible" />
                            <Setter Property="IsEnabled" Value="True" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding ResultssManager.SelectedResultsDatabase.IsLocked}" Value="True">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                                <DataTrigger Binding="{Binding CurrentSelectedSector, Converter={StaticResource IsNullOrEmpty}}" Value="True">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Path=Tag, RelativeSource={RelativeSource AncestorType=ContentControl}}" Value="Image">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <!--  Clear Single Sector: Clears the selected sector. Visible only for "Sectors" context when a sector is selected.  -->
                <Button
                    Width="28"
                    Command="{Binding ClearSingleCommand}"
                    Content="{iconPacks:MaterialDesign Kind=Clear}"
                    Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}"
                    ToolTip="Clear the selected sector.">

                    <Button.Style>
                        <Style BasedOn="{StaticResource MahApps.Styles.Button.Hamburger}" TargetType="{x:Type Button}">
                            <Setter Property="Visibility" Value="Visible" />
                            <Setter Property="IsEnabled" Value="True" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding CurrentSelectedSector, Converter={StaticResource IsNullOrEmpty}}" Value="True">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Path=Tag, RelativeSource={RelativeSource AncestorType=ContentControl}}" Value="Image">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <!--  Read from Device: Reads the last results and image from the connected device.  -->
                <Button
                    Width="28"
                    Command="{Binding ReadCommand}"
                    Content="{iconPacks:Material Kind=Upload}"
                    Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}"
                    ToolTip="Read the last results and image from the device.&#x0a;This action does not process the data.">

                    <Button.Style>
                        <Style BasedOn="{StaticResource MahApps.Styles.Button.Hamburger}" TargetType="{x:Type Button}">
                            <Setter Property="Visibility" Value="Collapsed" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding ResultssManager.SelectedL95.Controller.IsConnected}" Value="True">
                                    <Setter Property="Visibility" Value="Visible" />
                                </DataTrigger>
                                <MultiDataTrigger>
                                    <MultiDataTrigger.Conditions>
                                        <Condition Binding="{Binding Path=Tag, RelativeSource={RelativeSource AncestorType=ContentControl}}" Value="Image" />
                                        <Condition Binding="{Binding CurrentSectors.Count, Converter={StaticResource NumberZeroOrNull}}" Value="False" />
                                    </MultiDataTrigger.Conditions>
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </MultiDataTrigger>

                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>


                <DockPanel>
                    <DockPanel.Style>
                        <Style TargetType="{x:Type DockPanel}">
                            <Setter Property="Visibility" Value="Visible" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Path=Tag, RelativeSource={RelativeSource AncestorType=ContentControl}}" Value="Image">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DockPanel.Style>

                    <Border Margin="3,0" Style="{StaticResource imageBar}" />

                </DockPanel>

                <!--  Copy to Clipboard: Copies the current image or sectors to the clipboard.  -->
                <Button
                    Width="28"
                    Click="btnCopyToClipboard_Click"
                    Content="{iconPacks:Modern Kind=PageCopy}"
                    Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}">
                    <Button.Style>
                        <Style BasedOn="{StaticResource MahApps.Styles.Button.Hamburger}" TargetType="{x:Type Button}">
                            <Setter Property="Tag" Value="{Binding CurrentSectors}" />
                            <Setter Property="ToolTip" Value="Copy the sectors to the clipboard as CSV." />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Path=Tag, RelativeSource={RelativeSource AncestorType=ContentControl}}" Value="Image">
                                    <Setter Property="Tag" Value="{Binding CurrentImage}" />
                                    <Setter Property="ToolTip" Value="Copy the image to the clipboard as a bitmap." />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <!--  Buttons visible only when the context is "Sectors".  -->
                <Button
                    Width="28"
                    Click="CurrentSectors_Click"
                    Content="{iconPacks:Modern Kind=SectionExpandAll}"
                    Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}"
                    ToolTip="Show all stored sectors in a popup.&#x0a;Hold Shift and click to show the template and report JSON.">
                    <Button.Style>
                        <Style BasedOn="{StaticResource MahApps.Styles.Button.Hamburger}" TargetType="{x:Type Button}">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Path=Tag, RelativeSource={RelativeSource AncestorType=ContentControl}}" Value="Image">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <!--  Buttons visible only when the context is "Sectors".  -->
                <Button
                    Width="28"
                    Click="CurrentSectors_Click"
                    Content="{iconPacks:Material Kind=CodeJson}"
                    Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}"
                    Tag="json"
                    ToolTip="Show the template and report JSON.">
                    <Button.Style>
                        <Style BasedOn="{StaticResource MahApps.Styles.Button.Hamburger}" TargetType="{x:Type Button}">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Path=Tag, RelativeSource={RelativeSource AncestorType=ContentControl}}" Value="Image">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Button.Style>
                </Button>

                <DockPanel>
                    <DockPanel.Style>
                        <Style TargetType="{x:Type DockPanel}">
                            <Setter Property="Visibility" Value="Visible" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Path=Tag, RelativeSource={RelativeSource AncestorType=ContentControl}}" Value="Sectors">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DockPanel.Style>

                    <Border Margin="3,0" Style="{StaticResource imageBar}" />

                    <Button
                        Width="28"
                        Command="{Binding ClearCurrentCommand}"
                        CommandParameter="{x:Static vm:ResultsEntryDevices.L95}"
                        Content="{iconPacks:MaterialDesign Kind=Clear}"
                        Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}"
                        Style="{StaticResource MahApps.Styles.Button.Hamburger}"
                        ToolTip="Clear the current sectors and image." />

                </DockPanel>

            </DockPanel>

        </ResourceDictionary>
    </UserControl.Resources>

    <!--  Main container for the control. It's only visible if there are stored or current sectors to display.  -->
    <DockPanel MaxHeight="800">
        <DockPanel.Style>
            <Style TargetType="DockPanel">
                <Setter Property="Visibility" Value="Collapsed" />
                <Style.Triggers>
                    <DataTrigger Binding="{Binding StoredSectors.Count, Converter={StaticResource NumberZeroOrNull}}" Value="False">
                        <Setter Property="Visibility" Value="Visible" />
                    </DataTrigger>

                    <DataTrigger Binding="{Binding CurrentSectors.Count, Converter={StaticResource NumberZeroOrNull}}" Value="False">
                        <Setter Property="Visibility" Value="Visible" />
                    </DataTrigger>
                </Style.Triggers>
            </Style>
        </DockPanel.Style>

        <!--  Decorative borders for styling.  -->
        <Border Background="{DynamicResource L95_Brush_Active}" Style="{StaticResource groupLeft}" />
        <Border Background="{DynamicResource L95_Brush_Active}" Style="{StaticResource groupBottom}" />

        <!--  Section for displaying stored data (image and sectors).  -->
        <DockPanel>

            <!--  Stored Image Display: Visible only if a stored image exists.  -->
            <DockPanel DockPanel.Dock="Top">
                <DockPanel.Style>
                    <Style TargetType="{x:Type DockPanel}">
                        <Setter Property="Visibility" Value="Collapsed" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding StoredImage, Converter={StaticResource IsNullOrEmpty}}" Value="False">
                                <Setter Property="Visibility" Value="Visible" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </DockPanel.Style>

                <!--  Card containing the title and toolbar for the stored image.  -->
                <md:Card
                    Margin="3,3,0,0"
                    HorizontalAlignment="Left"
                    Background="{DynamicResource MahApps.HamburgerMenu.Pane.Background}"
                    DockPanel.Dock="Top"
                    Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}">

                    <DockPanel>

                        <DockPanel Background="Purple">
                            <iconPacks:PackIconMaterial
                                Width="12"
                                Margin="3"
                                VerticalAlignment="Center"
                                Kind="StoreOutline" />
                        </DockPanel>

                        <!--  Title for the stored image section.  -->
                        <md:Card
                            Margin="3,3,0,3"
                            Padding="4,1"
                            HorizontalAlignment="Left"
                            Background="{DynamicResource L95_Brush_Active}">
                            <TextBlock FontSize="{DynamicResource MahApps.Font.Size.ContextMenu}" Text="Stored Image" />
                        </md:Card>

                        <!--  Toolbar for the stored image.  -->
                        <ContentControl Content="{StaticResource L95Stored_Toolbar}" Tag="Image" />


                    </DockPanel>

                </md:Card>

                <!--  Container for the stored image itself.  -->
                <DockPanel
                    Margin="3"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Top"
                    Background="Black">

                    <Grid
                        MaxWidth="{Binding ResultsEntry.ImagesMaxHeight}"
                        MaxHeight="{Binding ResultsEntry.ImagesMaxHeight}"
                        Margin="3"
                        MouseDown="StoredImage_MouseDown"
                        ToolTip="Click to open a larger view of the image.&#x0a;Hold Shift and click to open a 3D view of the image.">

                        <!--  Base image.  -->
                        <Image RenderOptions.BitmapScalingMode="NearestNeighbor" Source="{Binding StoredImage.ImageLow, Mode=OneWay}" />

                        <!--  Overlay image, e.g., for highlighting sectors.  -->
                        <Image RenderOptions.BitmapScalingMode="NearestNeighbor" Source="{Binding StoredImageOverlay, Mode=OneWay}" />

                    </Grid>

                </DockPanel>

            </DockPanel>

            <!--  Stored Sectors Display: Visible only if there are stored sectors.  -->
            <DockPanel HorizontalAlignment="Left">
                <DockPanel.Style>
                    <Style TargetType="{x:Type DockPanel}">
                        <Setter Property="Visibility" Value="Collapsed" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding StoredSectors.Count, Converter={StaticResource NumberZeroOrNull}}" Value="False">
                                <Setter Property="Visibility" Value="Visible" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </DockPanel.Style>

                <!--  Card containing the title and toolbar for the stored sectors.  -->
                <md:Card
                    Margin="3,3,0,0"
                    HorizontalAlignment="Left"
                    Background="{DynamicResource MahApps.HamburgerMenu.Pane.Background}"
                    DockPanel.Dock="Top"
                    Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}">

                    <StackPanel>
                        <DockPanel>

                            <DockPanel Background="Purple">
                                <iconPacks:PackIconMaterial
                                    Width="12"
                                    Margin="3"
                                    VerticalAlignment="Center"
                                    Kind="StoreOutline" />
                            </DockPanel>
                            <!--  Title for the stored sectors section.  -->
                            <md:Card
                                Margin="3,3,0,3"
                                Padding="4,1"
                                HorizontalAlignment="Left"
                                Background="{DynamicResource L95_Brush_Active}">
                                <TextBlock FontSize="{DynamicResource MahApps.Font.Size.ContextMenu}" Text="Stored Sectors" />
                            </md:Card>

                            <!--  Toolbar for the stored sectors.  -->
                            <ContentControl Content="{StaticResource L95Stored_Toolbar}" Tag="Sectors" />

                        </DockPanel>

                        <!--  Displays the version of the first stored sector.  -->
                        <TextBlock
                            Margin="10,0,0,0"
                            HorizontalAlignment="Left"
                            Style="{StaticResource MahApps.Styles.TextBlock.AutoCollapsing}"
                            Text="{Binding StoredSectors[0].Version}" />
                    </StackPanel>
                </md:Card>

                <!--  Toolbar for the focused stored sector. Visible only when a sector is focused.  -->
                <DockPanel
                    HorizontalAlignment="Right"
                    VerticalAlignment="Top"
                    DockPanel.Dock="Top">
                    <DockPanel.Style>
                        <Style TargetType="DockPanel">
                            <Setter Property="Visibility" Value="Visible" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding FocusedStoredSector, Converter={StaticResource IsNullOrEmpty}}" Value="True">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DockPanel.Style>

                    <md:Card
                        Margin="0,0,0,3"
                        HorizontalAlignment="Right"
                        Background="{DynamicResource MahApps.HamburgerMenu.Pane.Background}"
                        DockPanel.Dock="Top"
                        Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}">

                        <DockPanel>

                            <DockPanel Height="26.62" />

                            <!--  Save sector details as an image.  -->
                            <Button
                                Width="28"
                                Click="btnSaveImage_Click"
                                Content="{iconPacks:Material Kind=ContentSave}"
                                Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}"
                                Style="{StaticResource MahApps.Styles.Button.Hamburger}"
                                ToolTip="Save the sector details as a PNG image." />

                            <!--  Copy sector details image to clipboard.  -->
                            <Button
                                Width="28"
                                Click="btnCopyImage_Click"
                                Content="{iconPacks:MaterialDesign Kind=Image}"
                                Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}"
                                Style="{StaticResource MahApps.Styles.Button.Hamburger}"
                                ToolTip="Copy the sector details to the clipboard as a PNG image." />

                            <!--  Copy focused sector data as CSV.  -->
                            <Button
                                Width="28"
                                Command="{Binding FocusedStoredSector.CopyToClipBoardCommand}"
                                CommandParameter="{Binding ResultsEntry.SourceImage.Order}"
                                Content="{iconPacks:Material Kind=ContentCopy}"
                                Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}"
                                Style="{StaticResource MahApps.Styles.Button.Hamburger}"
                                ToolTip="Copy the focused sector to the clipboard as CSV." />

                            <!--  Close the sector details view.  -->
                            <Button
                                Width="28"
                                Click="btnCloseDetails_Click"
                                Content="{iconPacks:MaterialDesign Kind=Close}"
                                Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}"
                                Style="{StaticResource MahApps.Styles.Button.Hamburger}"
                                Tag="Stored"
                                ToolTip="Close the sector details view.&#x0a;Hold Shift and click to close all details views." />

                        </DockPanel>
                    </md:Card>
                </DockPanel>

                <!--  Scrollable area for the list of stored sectors.  -->
                <ScrollViewer
                    x:Name="ScrollStoredSectors"
                    Margin="3"
                    mah:ScrollViewerHelper.BubbleUpScrollEventToParentScrollviewer="{Binding Path=ComputedVerticalScrollBarVisibility, ElementName=ScrollStoredSectors, Converter={StaticResource ScrollBarNotVisibleToBool}}"
                    ScrollChanged="ScrollStoredSectors_ScrollChanged"
                    VerticalScrollBarVisibility="Auto">

                    <DockPanel>

                        <!--  ListBox to display all stored sectors. It is hidden when a sector is focused to show details instead.  -->
                        <ListBox
                            Padding="0,1,0,0"
                            DockPanel.Dock="Top"
                            ItemsSource="{Binding Source={StaticResource StoredSectorsViewSource}}"
                            PreviewMouseWheel="StoredSectors_PreviewMouseWheel"
                            Tag="l95Stored">

                            <ListBox.Style>
                                <Style BasedOn="{StaticResource MahApps.Styles.ListBox}" TargetType="ListBox">
                                    <Setter Property="Visibility" Value="Visible" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding FocusedStoredSector, Converter={StaticResource IsNullOrEmpty}}" Value="False">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </ListBox.Style>

                            <ListBox.ItemContainerStyle>
                                <Style BasedOn="{StaticResource MahApps.Styles.ListBoxItem}" TargetType="ListBoxItem">
                                    <Setter Property="VerticalContentAlignment" Value="Stretch" />
                                    <Setter Property="Padding" Value="2" />
                                </Style>
                            </ListBox.ItemContainerStyle>

                            <!--  The WrapPanel arranges sectors in a grid-like layout that adjusts based on available width.  -->
                            <ListBox.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel HorizontalAlignment="Left" Orientation="Horizontal">
                                        <WrapPanel.Style>
                                            <Style TargetType="WrapPanel">
                                                <Setter Property="ItemWidth" Value="200" />
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding ResultsEntry.ImagesMaxHeight}" Value="400">
                                                        <Setter Property="MaxWidth" Value="400" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding ResultsEntry.ImagesMaxHeight}" Value="300">
                                                        <Setter Property="MaxWidth" Value="400" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding ResultsEntry.ImagesMaxHeight}" Value="200">
                                                        <Setter Property="MaxWidth" Value="200" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding ResultsEntry.ImagesMaxHeight}" Value="100">
                                                        <Setter Property="MaxWidth" Value="200" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding ResultsEntry.DualSectorColumns}" Value="True">
                                                        <Setter Property="MaxWidth" Value="400" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </WrapPanel.Style>
                                    </WrapPanel>
                                </ItemsPanelTemplate>
                            </ListBox.ItemsPanel>

                            <!--  Each item in the ListBox is a Sector control.  -->
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <sectors:Sector
                                        Background="{DynamicResource AccentColorBrush}"
                                        MouseEnter="storedSectorMouseEnter"
                                        MouseLeave="storedSectorMouseLeave" />
                                </DataTemplate>
                            </ListBox.ItemTemplate>

                        </ListBox>

                        <!--  Panel to display the details of a focused stored sector. Visible only when a sector is focused.  -->
                        <DockPanel HorizontalAlignment="Center" VerticalAlignment="Top">
                            <DockPanel.Style>
                                <Style TargetType="DockPanel">
                                    <Setter Property="Visibility" Value="Visible" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding FocusedStoredSector, Converter={StaticResource IsNullOrEmpty}}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </DockPanel.Style>

                            <!--  This DockPanel is a container for the SectorDetails control, used for saving/copying the visual.  -->
                            <DockPanel>
                                <sectors:SectorDetails DataContext="{Binding FocusedStoredSector}">
                                    <sectors:SectorDetails.Style>
                                        <Style TargetType="sectors:SectorDetails">
                                            <Setter Property="Width" Value="200" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding DataContext.ResultsEntry.ImagesMaxHeight, RelativeSource={RelativeSource AncestorType=DockPanel}}" Value="400">
                                                    <Setter Property="MaxWidth" Value="400" />
                                                    <Setter Property="Width" Value="auto" />
                                                </DataTrigger>

                                                <DataTrigger Binding="{Binding DataContext.ResultsEntry.ImagesMaxHeight, RelativeSource={RelativeSource AncestorType=DockPanel}}" Value="300">
                                                    <Setter Property="MaxWidth" Value="400" />
                                                    <Setter Property="Width" Value="auto" />
                                                </DataTrigger>

                                                <DataTrigger Binding="{Binding DataContext.ResultsEntry.DualSectorColumns, RelativeSource={RelativeSource AncestorType=DockPanel}}" Value="True">
                                                    <Setter Property="MaxWidth" Value="400" />
                                                    <Setter Property="Width" Value="auto" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </sectors:SectorDetails.Style>
                                </sectors:SectorDetails>
                            </DockPanel>
                        </DockPanel>
                    </DockPanel>
                </ScrollViewer>
            </DockPanel>

        </DockPanel>

        <!--  Detailed view for the stored image, shown when toggled.  -->
        <ContentControl Content="{Binding StoredImage, Mode=OneWay}" ContentTemplate="{StaticResource imageDetailsTemplate}">
            <ContentControl.Style>
                <Style TargetType="{x:Type ContentControl}">
                    <Setter Property="Visibility" Value="Collapsed" />
                    <Style.Triggers>
                        <MultiDataTrigger>
                            <MultiDataTrigger.Conditions>
                                <Condition Binding="{Binding ResultsEntry.ShowDetails}" Value="True" />
                                <Condition Binding="{Binding ResultRow, Converter={StaticResource IsNotNull}}" Value="true" />
                            </MultiDataTrigger.Conditions>
                            <Setter Property="Visibility" Value="Visible" />
                        </MultiDataTrigger>
                    </Style.Triggers>
                </Style>
            </ContentControl.Style>
        </ContentControl>

        <!--  Section for displaying current data (image and sectors).  -->
        <DockPanel>

            <!--  Current Image Display: Visible only if a current image exists.  -->
            <DockPanel Margin="3,0" DockPanel.Dock="Top">
                <DockPanel.Style>
                    <Style TargetType="{x:Type DockPanel}">
                        <Setter Property="Visibility" Value="Collapsed" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding CurrentImage, Mode=OneWay, Converter={StaticResource IsNullOrEmpty}}" Value="False">
                                <Setter Property="Visibility" Value="Visible" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </DockPanel.Style>

                <!--  Card containing the title and toolbar for the current image.  -->
                <md:Card
                    Margin="3,3,0,0"
                    HorizontalAlignment="Left"
                    Background="{DynamicResource MahApps.HamburgerMenu.Pane.Background}"
                    DockPanel.Dock="Top"
                    Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}">

                    <DockPanel>

                        <!--  Title for the current image section.  -->
                        <md:Card
                            Margin="3"
                            Padding="4,1"
                            HorizontalAlignment="Left"
                            Background="{DynamicResource L95_Brush_Active}">
                            <TextBlock FontSize="{DynamicResource MahApps.Font.Size.ContextMenu}" Text="Current Image" />
                        </md:Card>

                        <!--  Toolbar for the current image.  -->
                        <ContentControl Content="{StaticResource CurrentToolbar}" Tag="Image" />

                    </DockPanel>

                </md:Card>

                <!--  Container for the current image itself.  -->
                <DockPanel
                    Margin="3"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Top"
                    Background="Black">

                    <Grid
                        MaxWidth="{Binding ResultsEntry.ImagesMaxHeight}"
                        MaxHeight="{Binding ResultsEntry.ImagesMaxHeight}"
                        Margin="3"
                        MouseDown="CurrentImage_MouseDown"
                        ToolTip="Click to open a larger view of the image.&#x0a;Hold Shift and click to open a 3D view of the image.">

                        <!--  Base image.  -->
                        <Image RenderOptions.BitmapScalingMode="NearestNeighbor" Source="{Binding CurrentImage.ImageLow, Mode=OneWay}" />

                        <!--  Overlay image.  -->
                        <Image RenderOptions.BitmapScalingMode="NearestNeighbor" Source="{Binding CurrentImageOverlay, Mode=OneWay}" />
                    </Grid>

                </DockPanel>

            </DockPanel>

            <!--  Current Sectors Display: Visible only if there are current sectors.  -->
            <DockPanel HorizontalAlignment="Left">
                <DockPanel.Style>
                    <Style TargetType="{x:Type DockPanel}">
                        <Setter Property="Visibility" Value="Collapsed" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding CurrentSectors.Count, Converter={StaticResource NumberZeroOrNull}}" Value="False">
                                <Setter Property="Visibility" Value="Visible" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </DockPanel.Style>

                <!--  Card containing the title and toolbar for the current sectors.  -->
                <md:Card
                    Margin="3,3,0,0"
                    HorizontalAlignment="Left"
                    Background="{DynamicResource MahApps.HamburgerMenu.Pane.Background}"
                    DockPanel.Dock="Top"
                    Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}">

                    <StackPanel>
                        <DockPanel>

                            <!--  Title for the current sectors section.  -->
                            <md:Card
                                Margin="3"
                                Padding="4,1"
                                HorizontalAlignment="Left"
                                Background="{DynamicResource L95_Brush_Active}">
                                <TextBlock FontSize="{DynamicResource MahApps.Font.Size.ContextMenu}" Text="Current Sectors" />
                            </md:Card>

                            <!--  Toolbar for the current sectors.  -->
                            <ContentControl Content="{StaticResource CurrentToolbar}" Tag="Sectors" />

                        </DockPanel>

                        <!--  Displays the version of the first current sector.  -->
                        <TextBlock
                            Margin="10,0,0,0"
                            HorizontalAlignment="Left"
                            Style="{StaticResource MahApps.Styles.TextBlock.AutoCollapsing}"
                            Text="{Binding CurrentSectors[0].Version}" />
                    </StackPanel>
                </md:Card>

                <!--  Toolbar for the focused current sector. Visible only when a sector is focused.  -->
                <DockPanel
                    HorizontalAlignment="Right"
                    VerticalAlignment="Top"
                    DockPanel.Dock="Top">
                    <DockPanel.Style>
                        <Style TargetType="DockPanel">
                            <Setter Property="Visibility" Value="Visible" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding FocusedCurrentSector, Converter={StaticResource IsNullOrEmpty}}" Value="True">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </DockPanel.Style>

                    <md:Card
                        Margin="0,0,0,3"
                        HorizontalAlignment="Right"
                        Background="{DynamicResource MahApps.HamburgerMenu.Pane.Background}"
                        DockPanel.Dock="Top"
                        Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}">

                        <DockPanel>

                            <DockPanel Height="26.62" />

                            <!--  Save sector details as an image.  -->
                            <Button
                                Width="28"
                                Click="btnSaveImage_Click"
                                Content="{iconPacks:Material Kind=ContentSave}"
                                Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}"
                                Style="{StaticResource MahApps.Styles.Button.Hamburger}"
                                ToolTip="Save the sector details as a PNG image." />

                            <!--  Copy sector details image to clipboard.  -->
                            <Button
                                Width="28"
                                Click="btnCopyImage_Click"
                                Content="{iconPacks:MaterialDesign Kind=Image}"
                                Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}"
                                Style="{StaticResource MahApps.Styles.Button.Hamburger}"
                                ToolTip="Copy the sector details to the clipboard as a PNG image." />

                            <!--  Copy focused sector data as CSV.  -->
                            <Button
                                Width="28"
                                Command="{Binding FocusedCurrentSector.CopyToClipBoardCommand}"
                                CommandParameter="{Binding ResultsEntry.SourceImage.Order}"
                                Content="{iconPacks:Material Kind=ContentCopy}"
                                Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}"
                                Style="{StaticResource MahApps.Styles.Button.Hamburger}"
                                ToolTip="Copy the focused sector to the clipboard as CSV." />

                            <!--  Close the sector details view.  -->
                            <Button
                                Width="28"
                                Click="btnCloseDetails_Click"
                                Content="{iconPacks:MaterialDesign Kind=Close}"
                                Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}"
                                Style="{StaticResource MahApps.Styles.Button.Hamburger}"
                                Tag="Current"
                                ToolTip="Close the sector details view.&#x0a;Hold Shift and click to close all details views." />

                        </DockPanel>
                    </md:Card>
                </DockPanel>

                <!--  Scrollable area for the list of current sectors.  -->
                <ScrollViewer
                    x:Name="ScrollCurrentSectors"
                    Margin="3"
                    mah:ScrollViewerHelper.BubbleUpScrollEventToParentScrollviewer="{Binding Path=ComputedVerticalScrollBarVisibility, ElementName=ScrollCurrentSectors, Converter={StaticResource ScrollBarNotVisibleToBool}}"
                    ScrollChanged="ScrollCurrentSectors_ScrollChanged"
                    VerticalScrollBarVisibility="Auto">
                    <Grid>

                        <!--  ListBox to display all current sectors. It is hidden when a sector is focused.  -->
                        <ListBox
                            Padding="0,1,0,0"
                            ItemsSource="{Binding Source={StaticResource CurrentSectorsViewSource}}"
                            PreviewMouseWheel="CurrentSectors_PreviewMouseWheel"
                            SelectedItem="{Binding CurrentSelectedSector}"
                            Tag="l95Current">

                            <ListBox.Style>
                                <Style BasedOn="{StaticResource MahApps.Styles.ListBox}" TargetType="ListBox">
                                    <Setter Property="Visibility" Value="Visible" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding FocusedCurrentSector, Converter={StaticResource IsNullOrEmpty}}" Value="False">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </ListBox.Style>

                            <ListBox.ItemContainerStyle>
                                <Style BasedOn="{StaticResource MahApps.Styles.ListBoxItem}" TargetType="ListBoxItem">
                                    <Setter Property="VerticalContentAlignment" Value="Stretch" />
                                    <Setter Property="Padding" Value="2" />
                                </Style>
                            </ListBox.ItemContainerStyle>

                            <!--  The WrapPanel arranges sectors in a grid-like layout.  -->
                            <ListBox.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel HorizontalAlignment="Left" Orientation="Horizontal">
                                        <WrapPanel.Style>
                                            <Style TargetType="WrapPanel">
                                                <Setter Property="ItemWidth" Value="200" />
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding ResultsEntry.ImagesMaxHeight}" Value="400">
                                                        <Setter Property="MaxWidth" Value="400" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding ResultsEntry.ImagesMaxHeight}" Value="300">
                                                        <Setter Property="MaxWidth" Value="400" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding ResultsEntry.ImagesMaxHeight}" Value="200">
                                                        <Setter Property="MaxWidth" Value="200" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding ResultsEntry.ImagesMaxHeight}" Value="100">
                                                        <Setter Property="MaxWidth" Value="200" />
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding ResultsEntry.DualSectorColumns}" Value="True">
                                                        <Setter Property="MaxWidth" Value="400" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </WrapPanel.Style>
                                    </WrapPanel>
                                </ItemsPanelTemplate>
                            </ListBox.ItemsPanel>

                            <!--  Each item in the ListBox is a Sector control.  -->
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <sectors:Sector
                                        Background="{DynamicResource AccentColorBrush}"
                                        MouseEnter="storedSectorMouseEnter"
                                        MouseLeave="storedSectorMouseLeave" />
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>

                        <!--  Panel to display the details of a focused current sector.  -->
                        <DockPanel HorizontalAlignment="Center" VerticalAlignment="Top">
                            <DockPanel.Style>
                                <Style TargetType="DockPanel">
                                    <Setter Property="Visibility" Value="Visible" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding FocusedCurrentSector, Converter={StaticResource IsNullOrEmpty}}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </DockPanel.Style>
                            <!--  This DockPanel is a container for the SectorDetails control, used for saving/copying the visual.  -->
                            <DockPanel>
                                <sectors:SectorDetails DataContext="{Binding FocusedCurrentSector}">
                                    <sectors:SectorDetails.Style>
                                        <Style TargetType="sectors:SectorDetails">
                                            <Setter Property="Width" Value="200" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding DataContext.ResultsEntry.ImagesMaxHeight, RelativeSource={RelativeSource AncestorType=DockPanel}}" Value="400">
                                                    <Setter Property="MaxWidth" Value="400" />
                                                    <Setter Property="Width" Value="auto" />
                                                </DataTrigger>

                                                <DataTrigger Binding="{Binding DataContext.ResultsEntry.ImagesMaxHeight, RelativeSource={RelativeSource AncestorType=DockPanel}}" Value="300">
                                                    <Setter Property="MaxWidth" Value="400" />
                                                    <Setter Property="Width" Value="auto" />
                                                </DataTrigger>

                                                <DataTrigger Binding="{Binding DataContext.ResultsEntry.DualSectorColumns, RelativeSource={RelativeSource AncestorType=DockPanel}}" Value="True">
                                                    <Setter Property="MaxWidth" Value="400" />
                                                    <Setter Property="Width" Value="auto" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </sectors:SectorDetails.Style>
                                </sectors:SectorDetails>
                            </DockPanel>
                        </DockPanel>
                    </Grid>
                </ScrollViewer>
            </DockPanel>

            <!--  Dissimilar Results Section: Displays sectors that have differences between the stored and current versions.  -->
            <DockPanel>
                <DockPanel.Style>
                    <Style TargetType="{x:Type DockPanel}">
                        <Setter Property="Visibility" Value="Collapsed" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding DiffSectors.Count, Converter={StaticResource NumberZeroOrNull}}" Value="False">
                                <Setter Property="Visibility" Value="Visible" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </DockPanel.Style>

                <!--  Card containing the title for the dissimilar results section.  -->
                <md:Card
                    Margin="3,3,0,0"
                    HorizontalAlignment="Left"
                    Background="{DynamicResource MahApps.HamburgerMenu.Pane.Background}"
                    DockPanel.Dock="Top"
                    Foreground="{DynamicResource MahApps.HamburgerMenu.Pane.Foreground}">

                    <DockPanel>

                        <!--  Title for the dissimilar results section.  -->
                        <md:Card
                            Margin="3"
                            Padding="4,1"
                            HorizontalAlignment="Left"
                            Background="{DynamicResource L95_Brush_Active}">
                            <TextBlock FontSize="{DynamicResource MahApps.Font.Size.ContextMenu}" Text="Dissimilar Results" />
                        </md:Card>

                        <Border Margin="3,0" Style="{StaticResource imageBar}" />

                    </DockPanel>
                </md:Card>

                <!--  Scrollable list of dissimilar sectors.  -->
                <ScrollViewer
                    Margin="3"
                    mah:ScrollViewerHelper.BubbleUpScrollEventToParentScrollviewer="True"
                    VerticalScrollBarVisibility="Auto">

                    <ListView
                        Padding="0,1,0,0"
                        ItemsSource="{Binding DiffSectors}"
                        Style="{StaticResource MahApps.Styles.ListView}">

                        <ListView.ItemContainerStyle>
                            <Style BasedOn="{StaticResource MahApps.Styles.ListViewItem}" TargetType="ListViewItem">
                                <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                            </Style>
                        </ListView.ItemContainerStyle>

                        <!--  Each item is a SectorDifferences control that highlights the differences.  -->
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <sectors:SectorDifferences
                                    Width="220"
                                    Margin="6,0"
                                    Background="{StaticResource AccentColorBrush}" />
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </ScrollViewer>

            </DockPanel>

        </DockPanel>

        <!--  Detailed view for the current image, shown when toggled.  -->
        <ContentControl Content="{Binding CurrentImage, Mode=OneWay}" ContentTemplate="{StaticResource imageDetailsTemplate}">
            <ContentControl.Style>
                <Style TargetType="{x:Type ContentControl}">
                    <Setter Property="Visibility" Value="Collapsed" />
                    <Style.Triggers>
                        <MultiDataTrigger>
                            <MultiDataTrigger.Conditions>
                                <Condition Binding="{Binding ResultsEntry.ShowDetails}" Value="True" />
                                <Condition Binding="{Binding Path=DataContext.CurrentImage, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource IsNotNull}}" Value="True" />
                            </MultiDataTrigger.Conditions>
                            <Setter Property="Visibility" Value="Visible" />
                        </MultiDataTrigger>
                    </Style.Triggers>
                </Style>
            </ContentControl.Style>
        </ContentControl>

    </DockPanel>
</UserControl>